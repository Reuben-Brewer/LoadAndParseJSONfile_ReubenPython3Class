# -*- coding: utf-8 -*-

'''
Reuben Brewer, Ph.D.
reuben.brewer@gmail.com
www.reubotics.com

Apache 2 License
Software Revision B, 07/16/2025

Verified working on: Python 3.11/3.12 for Windows 10, 11 64-bit and Raspberry Pi Bookworm.
'''

__author__ = 'reuben.brewer'

#########################################################
from LoadAndParseJSONfile_ReubenPython3Class import *
#########################################################

##########################################################################################################
import os
import sys

import time
import traceback
import keyboard
##########################################################################################################

#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
def GetGlobals(PrintForDebuggingFlag=0):

    GlobalsDict = dict() #Don't simply deepcopy() globals() because you can't pickle some objects.

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    try:

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        for Key, Value in globals().items():

            #######################################################################################################################
            #######################################################################################################################
            #######################################################################################################################
            try:

                #######################################################################################################################
                #######################################################################################################################
                ValueType = type(Value)

                ValueType_AllowedList = [bool,
                                        int,
                                        float,
                                        str,
                                        list,
                                        tuple,
                                        dict,
                                        type(None),# NoneType
                                        bytes,
                                        bytearray]
                #######################################################################################################################
                #######################################################################################################################

                #######################################################################################################################
                #######################################################################################################################
                if ValueType in ValueType_AllowedList:

                    #######################################################################################################################
                    try:
                        GlobalsDict[Key] = deepcopy(Value)

                        if PrintForDebuggingFlag == 1:
                            print(str(Key) + ": " + str(Value))
                    #######################################################################################################################

                    #######################################################################################################################
                    except Exception as e:
                        GlobalsDict[Key] = "CannotCopy"
                    #######################################################################################################################

                #######################################################################################################################
                #######################################################################################################################

                #######################################################################################################################
                #######################################################################################################################
                else:
                    GlobalsDict[Key] = "CannotCopy"
                #######################################################################################################################
                #######################################################################################################################

            #######################################################################################################################
            #######################################################################################################################
            #######################################################################################################################

            #######################################################################################################################
            #######################################################################################################################
            #######################################################################################################################
            except:
                GlobalsDict[Key] = "CannotCopy"
            #######################################################################################################################
            #######################################################################################################################
            #######################################################################################################################

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    except:
        exceptions = sys.exc_info()[0]
        print("GetGlobals: Exceptions: %s" % exceptions)
        #return GlobalsDict
        traceback.print_exc()
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    if PrintForDebuggingFlag == 1:
        print("%%% Start of GlobalsDict %%%" + str(GlobalsDict))

        for Key in GlobalsDict:
            print(str(Key) + ": " + str(GlobalsDict[Key]))

        print("%%% End of GlobalsDict %%%" + str(GlobalsDict))

    return GlobalsDict
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################

##########################################################################################################
##########################################################################################################
def ExitProgram_Callback(OptionalArugment = 0):
    global EXIT_PROGRAM_FLAG

    print("ExitProgram_Callback event fired!")

    EXIT_PROGRAM_FLAG = 1
##########################################################################################################
##########################################################################################################

#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
def CheckForJSONfileChangesAndCopyDataToGlobalsIfNeeded(GlobalDictToModify):
    global LoadAndParseJSONfile_Object
    global LoadAndParseJSONfile_OPEN_FLAG
    global LoadAndParseJSONfile_MostRecentDict

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    if LoadAndParseJSONfile_OPEN_FLAG == 1:

        LoadAndParseJSONfile_MostRecentDict = LoadAndParseJSONfile_Object.GetMostRecentDataDict()
        #print("LoadAndParseJSONfile_MostRecentDict: " + str(LoadAndParseJSONfile_MostRecentDict))

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        for FilenameFullPath in LoadAndParseJSONfile_MostRecentDict:

            EventCounter = LoadAndParseJSONfile_MostRecentDict[FilenameFullPath]["EventCounter"]
            EventCounterAtWhichMainProgramLastUpdated = LoadAndParseJSONfile_MostRecentDict[FilenameFullPath]["EventCounterAtWhichMainProgramLastUpdated"]

            #######################################################################################################################
            #######################################################################################################################
            if EventCounter > EventCounterAtWhichMainProgramLastUpdated:

                DataDictFromJSONfile = LoadAndParseJSONfile_MostRecentDict[FilenameFullPath]["DataDictFromJSONfile"]

                #######################################################################################################################
                for Key in DataDictFromJSONfile:
                    GlobalDictToModify[Key] = DataDictFromJSONfile[Key]
                #######################################################################################################################

                #######################################################################################################################
                print("Updated global variables within " + FilenameFullPath)
                LoadAndParseJSONfile_Object.UpdateReadingRecord(FilenameFullPath, EventCounter)
                #######################################################################################################################

            #######################################################################################################################
            #######################################################################################################################

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################

#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
if __name__ == '__main__': #unicorn

    print("test_program_for_LoadAndParseJSONfile_ReubenPython3Class.py, Starting.")

    #################################################
    #################################################
    global OSnameStr
    OSnameStr = LoadAndParseJSONfile_ReubenPython3Class.GetOSnameStr()
    
    global EXIT_PROGRAM_FLAG
    EXIT_PROGRAM_FLAG = 0

    global USE_LoadAndParseJSONfile_FLAG
    USE_LoadAndParseJSONfile_FLAG = 1

    global CurrentTime_MainLoopThread
    CurrentTime_MainLoopThread = -11111.0

    global StartingTime_MainLoopThread
    StartingTime_MainLoopThread = -11111.0
    #################################################
    #################################################
    
    #################################################
    #################################################
    global LoadAndParseJSONfile_Object

    global LoadAndParseJSONfile_OPEN_FLAG
    LoadAndParseJSONfile_OPEN_FLAG = 0

    global LoadAndParseJSONfile_MostRecentDict
    LoadAndParseJSONfile_MostRecentDict = dict()
    #################################################
    #################################################
    
    #################################################
    #################################################
    keyboard.on_press_key("esc", ExitProgram_Callback)
    #################################################
    #################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

    #################################################
    #################################################
    
    #################################################
    FilenameFullPathsToWatchList = [os.path.join(os.getcwd(), "TEST_1.json"),
                                    os.path.join(os.getcwd(), "TEST_2.json"),
                                    os.path.join(os.getcwd(), "TEST_3.json")]
    #################################################

    #################################################
    global LoadAndParseJSONfile_SetupDict
    LoadAndParseJSONfile_SetupDict = dict([("FilenameFullPathsToWatchList", FilenameFullPathsToWatchList)])
    #################################################

    #################################################
    if USE_LoadAndParseJSONfile_FLAG == 1 and EXIT_PROGRAM_FLAG == 0:
        try:
            LoadAndParseJSONfile_Object = LoadAndParseJSONfile_ReubenPython3Class(LoadAndParseJSONfile_SetupDict)
            LoadAndParseJSONfile_OPEN_FLAG = LoadAndParseJSONfile_Object.OBJECT_CREATED_SUCCESSFULLY_FLAG

            if LoadAndParseJSONfile_OPEN_FLAG == 1:
                CheckForJSONfileChangesAndCopyDataToGlobalsIfNeeded(globals())

        except:
            exceptions = sys.exc_info()[0]
            print("LoadAndParseJSONfile_ReubenPython3ClassObject __init__, exceptions: %s" % exceptions)
            traceback.print_exc()
    #################################################

    #################################################
    #################################################

    #################################################
    #################################################
    if USE_LoadAndParseJSONfile_FLAG == 1:
        if EXIT_PROGRAM_FLAG == 0:
            if LoadAndParseJSONfile_OPEN_FLAG != 1:
                print("Failed to open LoadAndParseJSONfile_ReubenPython3Class.")
                ExitProgram_Callback()
    #################################################
    #################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    while EXIT_PROGRAM_FLAG == 0:

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        CurrentTime_MainLoopThread = time.time() - StartingTime_MainLoopThread
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        CheckForJSONfileChangesAndCopyDataToGlobalsIfNeeded(globals())
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################

        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #print("Testing of this global variable is here: CSVdataLogger1_ReubenPython3ClassObject_setup_dict_VariableEnglishNameStringsForHeaderList = " + str(CSVdataLogger1_ReubenPython3ClassObject_setup_dict_VariableEnglishNameStringsForHeaderList))
        time.sleep(0.25)
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################
        #######################################################################################################################

    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

    #######################################################################################################################  THIS IS THE EXIT ROUTINE!
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    if LoadAndParseJSONfile_OPEN_FLAG == 1:
        LoadAndParseJSONfile_Object.ExitProgram_Callback()
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################
    #######################################################################################################################

    print("test_program_for_LoadAndParseJSONfile_ReubenPython3Class.py, Exiting.")

#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
#######################################################################################################################
